<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Autism Therapy Services Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:100vh; width:100vw; }

    /* Search bar */
    #search-wrapper {
      position: fixed;
      top: 20px; left: 50%; transform: translateX(-50%);
      max-width: 600px; width: 80%;
      z-index: 1000;
    }
    #search-wrapper .leaflet-control-geocoder-form input {
      width: 100% !important;
      padding: 10px 14px;
      border-radius: 25px;
      font-size: 16px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    /* Side panel for results */
    #results {
      position: fixed;
      top: 80px; right: 20px;
      width: 300px; max-height: 70%;
      overflow-y: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      padding: 10px;
      z-index: 999;
      font-family: sans-serif;
    }
    #results h3 { margin:0 0 10px; font-size:18px; }
    #results .item {
      padding: 6px; margin-bottom: 6px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    #results .item:hover { background:#f5f5f5; }
  </style>
</head>
<body>
  <div id="search-wrapper">
    <div id="search-container"></div>
  </div>
  <div id="map"></div>
  <div id="results" style="display:none">
    <h3>Nearby Services</h3>
    <div id="results-list"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    var map = L.map('map').setView([34.05, -118.25], 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var homeIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/69/69524.png",
      iconSize: [38, 38], iconAnchor: [19, 38], popupAnchor: [0, -38]
    });

    var defaultMarkers = L.geoJSON(null, {
      onEachFeature: function (feature, layer) {
        layer.bindPopup("<b>" + feature.properties.Name + "</b><br/>" +
                        feature.properties.Address + "<br/>" +
                        (feature.properties.Phone || ""));
      }
    }).addTo(map);

    fetch('services.geojson')
      .then(res => res.json())
      .then(data => { defaultMarkers.addData(data); });

    var geocoder = L.Control.geocoder({ defaultMarkGeocode: false }).addTo(map);
    var geocoderEl = document.querySelector('.leaflet-control-geocoder');
    document.getElementById('search-container').appendChild(geocoderEl);

    var searchMarker, bufferCircle;

    function distanceInMeters(a, b) {
      return map.distance(a, b);
    }

    geocoder.on('markgeocode', function(e) {
      var latlng = e.geocode.center;
      if (searchMarker) map.removeLayer(searchMarker);
      if (bufferCircle) map.removeLayer(bufferCircle);

      searchMarker = L.marker(latlng, { icon: homeIcon }).addTo(map)
        .bindPopup("🏠 " + e.geocode.name).openPopup();

      var miles = prompt("Enter buffer distance in miles:", "5");
      if (miles && !isNaN(miles)) {
        bufferCircle = L.circle(latlng, {
          radius: miles * 1609.34, color: 'blue', fillColor: '#cce5ff', fillOpacity: 0.2
        }).addTo(map);

        map.fitBounds(bufferCircle.getBounds());

        // Filter providers inside buffer
        var inside = [];
        defaultMarkers.eachLayer(function(layer) {
          if (layer.getLatLng && bufferCircle.getBounds().contains(layer.getLatLng())) {
            inside.push(layer);
          }
        });

        // Update results panel
        var resultsDiv = document.getElementById('results');
        var resultsList = document.getElementById('results-list');
        resultsList.innerHTML = "";
        if (inside.length > 0) {
          resultsDiv.style.display = "block";
          inside.forEach(function(layer) {
            var props = layer.feature.properties;
            var div = document.createElement('div');
            div.className = "item";
            div.innerHTML = "<b>" + props.Name + "</b><br/>" + props.Address;
            div.onclick = function() {
              map.setView(layer.getLatLng(), 15);
              layer.openPopup();
            };
            resultsList.appendChild(div);
          });
        } else {
          resultsDiv.style.display = "none";
        }
      } else {
        map.setView(latlng, 12);
      }
    });
  </script>
</body>
</html>
